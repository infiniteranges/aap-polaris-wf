---
# Generic Terragrunt Apply Role
# Executes 'terragrunt apply' in a specified working directory
# This role is component-agnostic and reusable

- name: Validate required variables
  assert:
    that:
      - working_dir is defined
      - working_dir != ""
    fail_msg: "working_dir must be defined and non-empty"
    quiet: true

- name: Check if plan file exists
  stat:
    path: "{{ working_dir }}/plan.out"
  register: plan_file_stat

- name: Run Terragrunt apply (with plan file)
  command: terragrunt apply --terragrunt-working-dir {{ working_dir }} {{ working_dir }}/plan.out
  environment: "{{ environment_vars | default({}) }}"
  register: terragrunt_apply
  when: plan_file_stat.stat.exists
  changed_when: false

- name: Run Terragrunt apply (without plan file - auto-approve)
  command: terragrunt apply --terragrunt-non-interactive --terragrunt-working-dir {{ working_dir }}
  environment: "{{ environment_vars | default({}) }}"
  register: terragrunt_apply
  when: not plan_file_stat.stat.exists
  changed_when: false

- name: Display Terragrunt apply output
  debug:
    var: terragrunt_apply.stdout_lines
  when: terragrunt_apply.stdout_lines is defined

- name: Save apply output to file
  copy:
    content: "{{ terragrunt_apply.stdout }}"
    dest: "{{ working_dir }}/apply_output.txt"
    mode: '0644'

- name: Collect Terraform outputs
  command: terragrunt output -json --terragrunt-working-dir {{ working_dir }}
  environment: "{{ environment_vars | default({}) }}"
  register: terragrunt_outputs
  changed_when: false
  failed_when: false

- name: Parse outputs JSON
  set_fact:
    component_outputs: "{{ terragrunt_outputs.stdout | from_json | default({}) }}"
  when: terragrunt_outputs.rc == 0

- name: Set empty outputs if collection failed
  set_fact:
    component_outputs: {}
  when: terragrunt_outputs.rc != 0

- name: Set apply result
  set_fact:
    apply_result:
      status: "{{ 'success' if terragrunt_apply.rc == 0 else 'failed' }}"
      output: "{{ terragrunt_apply.stdout }}"
      error: "{{ terragrunt_apply.stderr | default('') }}"
      outputs: "{{ component_outputs }}"
