---
# Generic Terragrunt Plan Role
# Executes 'terragrunt plan' in a specified working directory
# This role is component-agnostic and reusable

- name: Validate required variables
  assert:
    that:
      - working_dir is defined
      - working_dir != ""
    fail_msg: "working_dir must be defined and non-empty"
    quiet: true

- name: Check if Terragrunt is installed
  command: terragrunt --version
  register: terragrunt_version_check
  changed_when: false
  failed_when: false

- name: Install Terragrunt if not present
  block:
    - name: Download Terragrunt
      get_url:
        url: "https://github.com/gruntwork-io/terragrunt/releases/download/v0.54.0/terragrunt_linux_amd64"
        dest: "/tmp/terragrunt"
        mode: '0755'

    - name: Install Terragrunt to /usr/local/bin
      copy:
        src: "/tmp/terragrunt"
        dest: "/usr/local/bin/terragrunt"
        mode: '0755'
        remote_src: yes

    - name: Verify Terragrunt installation
      command: terragrunt --version
      register: terragrunt_installed
      changed_when: false
  when: terragrunt_version_check.rc != 0

- name: Check if Terraform is installed
  command: terraform --version
  register: terraform_version_check
  changed_when: false
  failed_when: false

- name: Install Terraform if not present
  block:
    - name: Download Terraform
      get_url:
        url: "https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip"
        dest: "/tmp/terraform.zip"

    - name: Unzip Terraform
      unarchive:
        src: "/tmp/terraform.zip"
        dest: "/tmp"
        remote_src: yes

    - name: Install Terraform to /usr/local/bin
      copy:
        src: "/tmp/terraform"
        dest: "/usr/local/bin/terraform"
        mode: '0755'
        remote_src: yes

    - name: Verify Terraform installation
      command: terraform --version
      register: terraform_installed
      changed_when: false
  when: terraform_version_check.rc != 0

- name: Ensure working directory exists
  file:
    path: "{{ working_dir }}"
    state: directory
    mode: '0755'

- name: Run Terragrunt init
  command: terragrunt init --terragrunt-working-dir {{ working_dir }}
  environment: "{{ environment_vars | default({}) }}"
  register: terragrunt_init
  changed_when: false

- name: Display Terragrunt init output
  debug:
    var: terragrunt_init.stdout_lines
  when: terragrunt_init.stdout_lines is defined

- name: Run Terragrunt plan
  command: terragrunt plan --terragrunt-working-dir {{ working_dir }} -out={{ working_dir }}/plan.out
  environment: "{{ environment_vars | default({}) }}"
  register: terragrunt_plan
  changed_when: false

- name: Display Terragrunt plan output
  debug:
    var: terragrunt_plan.stdout_lines
  when: terragrunt_plan.stdout_lines is defined

- name: Save plan output to file
  copy:
    content: "{{ terragrunt_plan.stdout }}"
    dest: "{{ working_dir }}/plan_output.txt"
    mode: '0644'

- name: Extract plan summary
  set_fact:
    plan_summary:
      additions: "{{ terragrunt_plan.stdout | regex_search('Plan: (\\d+) to add', '\\1') | default('0') | int }}"
      changes: "{{ terragrunt_plan.stdout | regex_search('(\\d+) to change', '\\1') | default('0') | int }}"
      deletions: "{{ terragrunt_plan.stdout | regex_search('(\\d+) to destroy', '\\1') | default('0') | int }}"

- name: Set plan result
  set_fact:
    plan_result:
      status: "{{ 'success' if terragrunt_plan.rc == 0 else 'failed' }}"
      output: "{{ terragrunt_plan.stdout }}"
      error: "{{ terragrunt_plan.stderr | default('') }}"
      summary: "{{ plan_summary }}"
      plan_file: "{{ working_dir }}/plan.out"
