---
# Terraform apply role
# Executes terraform apply using plan file and captures outputs

- name: Validate workspace path exists
  assert:
    that:
      - workspace_path is defined
      - workspace_path | length > 0
    fail_msg: "workspace_path must be defined and non-empty"
    success_msg: "Workspace path validated: {{ workspace_path }}"

- name: Check if workspace directory exists
  stat:
    path: "{{ workspace_path }}"
  register: workspace_stat

- name: Fail if workspace directory does not exist
  fail:
    msg: "Workspace directory does not exist: {{ workspace_path }}"
  when: not workspace_stat.stat.exists

- name: Check if plan file exists
  stat:
    path: "{{ workspace_path }}/{{ plan_file }}"
  register: plan_file_stat

- name: Fail if plan file does not exist
  fail:
    msg: "Plan file does not exist: {{ workspace_path }}/{{ plan_file }}. Run terraform plan first."
  when: not plan_file_stat.stat.exists

- name: Check if terraform binary is available (try system first, then local bin)
  shell: |
    if command -v terraform >/dev/null 2>&1; then
      terraform --version
    elif [ -f "$HOME/.local/bin/terraform" ]; then
      $HOME/.local/bin/terraform --version
    else
      exit 1
    fi
  register: terraform_binary_check
  changed_when: false
  failed_when: false
  ignore_errors: yes

- name: Determine terraform binary path
  set_fact:
    terraform_binary_path: "{{ 'terraform' if terraform_binary_check.rc == 0 else (ansible_env.HOME + '/.local/bin/terraform') }}"
  when: terraform_binary_check.rc is defined

- name: Fail if terraform binary not found
  fail:
    msg: |
      Terraform binary not found on the execution node.
      
      To fix this issue:
      1. Install Terraform on the execution node
      2. Ensure Terraform is in the system PATH
      3. Or use an execution environment with Terraform pre-installed
      
      Installation instructions:
      - https://developer.hashicorp.com/terraform/downloads
      - Or use: wget https://releases.hashicorp.com/terraform/VERSION/terraform_VERSION_linux_amd64.zip
      
      Current PATH: {{ ansible_env.PATH | default('not set') }}
  when: terraform_binary_check.rc != 0

- name: Build terraform apply command
  set_fact:
    terraform_apply_cmd: >-
      {{ terraform_binary_path | default(terraform_binary) }} apply
      {% if terraform_auto_approve %}
      -auto-approve
      {% endif %}
      {% if terraform_parallelism is defined and terraform_parallelism is not none %}
      -parallelism={{ terraform_parallelism }}
      {% endif %}
      {{ plan_file }}
      {% for arg in terraform_extra_args %}
      {{ arg }}
      {% endfor %}

- name: Execute terraform apply
  command: "{{ terraform_apply_cmd }}"
  args:
    chdir: "{{ workspace_path }}"
  environment: "{{ terraform_env | combine({'PATH': ansible_env.HOME + '/.local/bin:' + ansible_env.PATH}) }}"
  register: terraform_apply_result
  failed_when: false  # We'll check the return code manually

- name: Check if error is "already exists" (idempotent case)
  set_fact:
    is_already_exists_error: "{{ terraform_apply_result.stderr is defined and ('EntityAlreadyExists' in terraform_apply_result.stderr or 'already exists' in terraform_apply_result.stderr | lower) }}"
  when: terraform_apply_result.rc != 0

- name: Set apply status based on return code (handle already exists as success)
  set_fact:
    apply_status: "{{ 'success' if (terraform_apply_result.rc == 0 or (terraform_apply_result.rc != 0 and is_already_exists_error | default(false))) else 'failed' }}"
    apply_output: "{{ terraform_apply_result.stdout | default('') }}"
    apply_error: "{{ terraform_apply_result.stderr | default('') if (terraform_apply_result.rc != 0 and not (is_already_exists_error | default(false))) else '' }}"

- name: Get Terraform outputs
  command: "{{ terraform_binary_path | default(terraform_binary) }} output -json"
  args:
    chdir: "{{ workspace_path }}"
  environment: "{{ terraform_env | combine({'PATH': ansible_env.HOME + '/.local/bin:' + ansible_env.PATH}) }}"
  register: terraform_outputs_result
  failed_when: false
  when: apply_status == 'success'

- name: Parse Terraform outputs
  set_fact:
    terraform_outputs: "{{ terraform_outputs_result.stdout | from_json | default({}) }}"
  when:
    - apply_status == 'success'
    - terraform_outputs_result.rc == 0
    - terraform_outputs_result.stdout is defined

- name: Save outputs to file
  copy:
    content: "{{ terraform_outputs | to_nice_json }}"
    dest: "{{ workspace_path }}/{{ outputs_file }}"
    mode: '0644'
  when: terraform_outputs is defined

- name: Display apply summary
  debug:
    msg:
      - "Terraform apply completed"
      - "Status: {{ apply_status }}"
      - "Return code: {{ terraform_apply_result.rc }}"
      - "Outputs captured: {{ terraform_outputs is defined }}"
      - "Already exists (idempotent): {{ is_already_exists_error | default(false) }}"

- name: Warn if resource already exists (treated as success)
  debug:
    msg: "Resource already exists - treating as success (idempotent operation)"
  when: is_already_exists_error | default(false)

- name: Fail if apply failed
  fail:
    msg: "Terraform apply failed: {{ apply_error }}"
  when: apply_status == 'failed'
