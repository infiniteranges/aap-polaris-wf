---
# Generic Callback Notification Role
# Sends status updates to Polaris orchestration service
# This role is component-agnostic and reusable

- name: Validate required variables
  assert:
    that:
      - callback_base_url is defined
      - callback_base_url != ""
      - deployment_id is defined
      - deployment_id != ""
      - stack_type is defined
      - stack_type != ""
      - component is defined
      - component != ""
      - phase is defined
      - phase != ""
      - status is defined
      - status != ""
    fail_msg: "All callback variables must be defined"
    quiet: true

- name: Build callback payload
  set_fact:
    callback_payload:
      deploymentId: "{{ deployment_id }}"
      stackType: "{{ stack_type }}"
      component: "{{ component }}"
      phase: "{{ phase }}"
      status: "{{ status }}"
      outputs: "{{ outputs | default({}) }}"
      error: "{{ error | default(null) }}"
      planSummary: "{{ plan_summary | default(null) }}"
      planOutput: "{{ plan_output | default(null) }}"
      applyOutput: "{{ apply_output | default(null) }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"

- name: Determine callback endpoint based on phase
  set_fact:
    callback_endpoint: "{{ callback_base_url }}/api/orchestration/stacks/executions/{{ deployment_id }}/{{ 'plan-callback' if phase == 'plan' else 'apply-callback' }}"

- name: Send callback to Polaris
  uri:
    url: "{{ callback_endpoint }}"
    method: POST
    body_format: json
    body: "{{ callback_payload }}"
    status_code: [200, 201, 404]
    headers:
      Content-Type: "application/json"
  register: callback_response
  failed_when: false
  ignore_errors: yes

- name: Display callback result
  debug:
    msg:
      - "Callback sent to: {{ callback_endpoint }}"
      - "Status code: {{ callback_response.status | default('unknown') }}"
      - "Response: {{ callback_response.json | default('no response') }}"
  when: callback_response.status is defined

- name: Warn if callback failed
  debug:
    msg: "Warning: Callback to Polaris failed. Status: {{ callback_response.status | default('unknown') }}"
  when: callback_response.status is not defined or callback_response.status not in [200, 201]
