---
# Terraform Create Configuration Playbook
# Creates the main.tf configuration file that uses the cloned module

- name: Create Terraform Configuration
  hosts: localhost
  gather_facts: yes
  
  tasks:
    # ============================================
    # Phase 0.1: Determine workspace name (support both TFC and local Terraform)
    # ============================================
    - name: Set workspace name (support both tfc_workspace_name and workspace_name, and workflow stats)
      set_fact:
        workspace_name: "{{ tfc_workspace_name | default(workspace_name) | default(ansible_stats.aggregate.workspace_name | default('')) }}"
    
    - name: Generate workspace name from variables if not set (deterministic hash)
      set_fact:
        workspace_name: "{{ 'terraform-' + (role_name | default(resource_name | default('resource')) | default('deployment')) + '-' + (aws_region | default(region | default('us-east-1'))) + '-' + ((role_name | default(resource_name | default('')) | default('') + aws_region | default(region | default('')) | default('') + tfc_pattern_repo_name | default('') | default('')) | hash('sha1') | truncate(8, True, '')) }}"
      when: workspace_name | length == 0

    - name: Set workspace path (use shared /tmp location, or from stats)
      set_fact:
        workspace_path: "{{ ansible_stats.aggregate.workspace_path | default('/tmp/awx-workspaces/' + workspace_name) }}"
    
    - name: Display workspace path for debugging
      debug:
        msg:
          - "Workspace path: {{ workspace_path }}"
          - "From stats: {{ ansible_stats.aggregate.workspace_path | default('NOT SET') }}"
          - "Workspace name: {{ workspace_name }}"
    
    - name: Ensure workspace directory exists
      file:
        path: "{{ workspace_path }}"
        state: directory
        mode: '0755'
      when: workspace_name is defined and workspace_name | length > 0

    - name: Display main.tf destination path
      debug:
        msg: "Creating main.tf at: {{ workspace_path }}/main.tf"
    
    - name: Verify workspace directory exists before creating main.tf
      stat:
        path: "{{ workspace_path }}"
      register: workspace_dir_stat
    
    - name: Fail if workspace directory doesn't exist
      fail:
        msg: "Workspace directory {{ workspace_path }} does not exist!"
      when: not workspace_dir_stat.stat.exists
    
    - name: Create main.tf configuration file
      copy:
        content: |
          terraform {
            required_version = ">= 1.0"
            required_providers {
              aws = {
                source  = "hashicorp/aws"
                version = "~> 5.0"
              }
            }
          }

          provider "aws" {
            region = "{{ (tfc_variables.aws_region | default(aws_region) | default('us-east-1')) }}"
          }

          resource "aws_iam_role" "this" {
            name = "{{ (tfc_variables.role_name | default(role_name)) }}"
            {% set assume_policy = tfc_variables.assume_role_policy | default(assume_role_policy, '') %}
            {% if assume_policy | length > 0 %}
            {% if assume_policy.startswith('{') or assume_policy.startswith('[') %}
            {% set escaped_policy = assume_policy | replace('\n', '\\n') | replace('\r', '') | replace('"', '\\"') %}
            assume_role_policy = jsonencode(jsondecode("{{ escaped_policy }}"))
            {% else %}
            assume_role_policy = jsonencode({
              Version = "2012-10-17"
              Statement = [
                {
                  Effect = "Allow"
                  Principal = {
                    Service = "{{ assume_policy }}.amazonaws.com"
                  }
                  Action = "sts:AssumeRole"
                }
              ]
            })
            {% endif %}
            {% else %}
            assume_role_policy = jsonencode({
              Version = "2012-10-17"
              Statement = [
                {
                  Effect = "Allow"
                  Principal = {
                    Service = "ec2.amazonaws.com"
                  }
                  Action = "sts:AssumeRole"
                }
              ]
            })
            {% endif %}
          }

          {% set policy_arns = tfc_variables.managed_policy_arns | default(managed_policy_arns, '') %}
          {% if policy_arns | length > 0 %}
          {% if policy_arns is string %}
          {% set policies = policy_arns.split(',') %}
          {% for policy in policies %}
          resource "aws_iam_role_policy_attachment" "managed_{{ loop.index }}" {
            role       = aws_iam_role.this.name
            policy_arn = "{{ policy.strip() }}"
          }
          {% endfor %}
          {% else %}
          {% for policy in policy_arns %}
          resource "aws_iam_role_policy_attachment" "managed_{{ loop.index }}" {
            role       = aws_iam_role.this.name
            policy_arn = "{{ policy }}"
          }
          {% endfor %}
          {% endif %}
          {% endif %}

          output "iam_role_arn" {
            value = aws_iam_role.this.arn
          }

          output "iam_role_name" {
            value = aws_iam_role.this.name
          }
        dest: "{{ workspace_path }}/main.tf"
        mode: '0644'
      when: 
        - workspace_name is defined and workspace_name | length > 0
        - tfc_pattern_repo_name is defined or role_name is defined
      register: main_tf_result
    
    - name: Verify main.tf was created
      stat:
        path: "{{ workspace_path }}/main.tf"
      register: main_tf_stat
    
    - name: Fail if main.tf doesn't exist after creation
      fail:
        msg: "main.tf was not created at {{ workspace_path }}/main.tf even though copy task succeeded!"
      when: not main_tf_stat.stat.exists
    
    - name: Display main.tf file details
      debug:
        msg:
          - "main.tf exists: {{ main_tf_stat.stat.exists }}"
          - "main.tf path: {{ main_tf_stat.stat.path }}"
          - "main.tf size: {{ main_tf_stat.stat.size | default('N/A') }} bytes"
    
    - name: List workspace directory contents after creation
      command: ls -la "{{ workspace_path }}"
      register: workspace_after
      changed_when: false
    
    - name: Display workspace contents after
      debug:
        var: workspace_after.stdout_lines
