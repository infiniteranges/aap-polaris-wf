---
# Terraform Plan Playbook
# Executes terraform plan and sends callbacks

- name: Execute Terraform Plan
  hosts: localhost
  gather_facts: yes
  vars:
    callback_phase: "plan"
    callback_status: "success"
    callback_endpoint: "plan_success"
  
  tasks:
    # ============================================
    # Phase 0.1: Determine workspace name (support both TFC and local Terraform)
    # ============================================
    - name: Set workspace name (support both tfc_workspace_name and workspace_name)
      set_fact:
        workspace_name: "{{ tfc_workspace_name | default(workspace_name) | default('') }}"
    
    - name: Generate workspace name from variables if not set (use workflow job ID for consistency)
      set_fact:
        workspace_name: "{{ 'terraform-' + (role_name | default(resource_name | default('resource')) | default('deployment')) + '-' + (aws_region | default(region | default('us-east-1'))) + '-' + (ansible_workflow_job_id | default(ansible_job_id | default(ansible_date_time.epoch)) | string) }}"
      when: workspace_name | length == 0

    - name: Ensure workspace directory exists
      file:
        path: "/tmp/workspaces/{{ workspace_name }}"
        state: directory
        mode: '0755'
      when: workspace_name is defined and workspace_name | length > 0

    # ============================================
    # Phase 0.5: Install Terraform (if not present)
    # ============================================
    - name: Install Terraform if not present
      include_role:
        name: install_terraform
      when: workspace_name is defined and workspace_name | length > 0

    # ============================================
    # Phase 0.6: Validate workspace name and check for config
    # ============================================
    - name: Validate workspace name is set
      fail:
        msg: |
          Workspace name is not defined or empty.
          
          For TFC: Set tfc_workspace_name variable
          For local Terraform: Set workspace_name variable, or provide role_name/resource_name and region
          
          Expected format: /tmp/workspaces/{workspace_name}
      when: workspace_name is not defined or workspace_name | length == 0

    - name: Check if main.tf exists
      stat:
        path: "/tmp/workspaces/{{ workspace_name }}/main.tf"
      register: main_tf_exists

    - name: Fail if main.tf does not exist with helpful error
      fail:
        msg: |
          ============================================
          ERROR: Terraform configuration file missing
          ============================================
          
          File not found: /tmp/workspaces/{{ workspace_name }}/main.tf
          
          This means the workflow is missing required steps before terraform-plan.
          
          REQUIRED WORKFLOW STEPS (in order):
          1. terraform-clone-repo    - Clone the Terraform module repository
          2. terraform-install        - Install Terraform (or done in plan step)
          3. terraform-create-config  - Create the main.tf configuration file
          4. terraform-plan           - Execute terraform plan (current step)
          5. terraform-apply          - Execute terraform apply
          
          CURRENT VARIABLES:
          - workspace_name: {{ workspace_name | default('NOT SET - This is the problem!') }}
          - tfc_workspace_name: {{ tfc_workspace_name | default('NOT SET') }}
          - tfc_pattern_repo_name: {{ tfc_pattern_repo_name | default('NOT SET') }}
          - tfc_pattern_version: {{ tfc_pattern_version | default('NOT SET') }}
          
          SOLUTION:
          Ensure your AAP workflow template (ID: {{ workflow_template_id | default('unknown') }}) 
          includes ALL required steps in the correct order.
          
          Check your workflow template configuration in AAP and ensure it has:
          - terraform-clone-repo job template
          - terraform-create-config job template  
          - terraform-plan job template (current)
          - terraform-apply job template
      when: not main_tf_exists.stat.exists

    - name: Filter out AWS credential variables from terraform_vars
      set_fact:
        filtered_terraform_vars: "{{ tfc_variables | default({}) | dict2items | rejectattr('key', 'in', ['aws_access_key_id', 'aws_secret_access_key', 'aws_session_token', 'aws_region']) | items2dict }}"

    - name: Execute terraform plan
      include_role:
        name: terraform_plan
      vars:
        workspace_path: "/tmp/workspaces/{{ workspace_name }}"
        terraform_vars: "{{ filtered_terraform_vars | default({}) }}"
      register: plan_result
      
    - name: Set plan result facts from role
      set_fact:
        plan_status: "{{ plan_result.plan_status | default('unknown') }}"
        plan_output: "{{ plan_result.plan_output | default('') }}"
        plan_error: "{{ plan_result.plan_error | default('') }}"

    # ============================================
    # Send Plan Success Callback
    # ============================================
    - name: Send plan success callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "plan"
        callback_status: "success"
        callback_endpoint: "plan_success"
        callback_plan_output: "{{ plan_output | default('') }}"
        deployment_id: "{{ workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when: 
        - plan_status == 'success'
        - callback_url is defined and callback_url | length > 0
      ignore_errors: yes

    # ============================================
    # Send Plan Failed Callback
    # ============================================
    - name: Send plan failed callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "plan"
        callback_status: "failed"
        callback_endpoint: "plan_failed"
        callback_error: "{{ plan_error | default('Plan execution failed') }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when: 
        - plan_status == 'failed'
        - callback_url is defined and callback_url | length > 0
      ignore_errors: yes

    # ============================================
    # Save plan status for subsequent workflow nodes
    # ============================================
    - name: Save plan status to JSON file for workflow variables
      copy:
        content: |
          {
            "plan_status": "{{ plan_status | default('unknown') }}",
            "plan_output": {{ plan_output | default('') | to_json }},
            "plan_error": {{ plan_error | default('') | to_json }}
          }
        dest: "/tmp/workspaces/{{ workspace_name }}/.plan_status.json"
        mode: '0644'
      when: plan_status is defined

    - name: Display plan summary
      debug:
        msg:
          - "Terraform plan completed"
          - "Status: {{ plan_status | default('unknown') }}"
          - "Workspace: {{ workspace_name }}"
