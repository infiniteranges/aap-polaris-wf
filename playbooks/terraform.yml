---
# Terraform execution playbook
# Orchestrates terraform plan and apply phases with callbacks

- name: Terraform Provision Playbook
  hosts: localhost
  gather_facts: yes
  vars:
    # Operation type: create, update, or destroy
    operation: "{{ tfc_operation | default('create') }}"
    
    # Callback configuration
    callback_phase: "plan"
    callback_status: "success"
    callback_endpoint: "plan_success"
    
  tasks:
    - name: Display execution context
      debug:
        msg:
          - "=== Terraform Execution Started ==="
          - "Operation: {{ operation }}"
          - "Repository: {{ tfc_pattern_repo_name }}"
          - "Version: {{ tfc_pattern_version }}"
          - "Workspace: {{ tfc_workspace_name }}"
          - "Cloud Provider: {{ tfc_cloud_provider }}"

    # ============================================
    # Phase 1: Clone Repository
    # ============================================
    - name: Clone repository to module subdirectory
      include_role:
        name: clone_repo
      vars:
        repo_url: "{{ tfc_pattern_repo_name }}"
        repo_version: "{{ tfc_pattern_version }}"
        repo_dest: "/tmp/workspaces/{{ tfc_workspace_name }}/module"

    # ============================================
    # Phase 1.5: Install Terraform (if not present)
    # ============================================
    - name: Install Terraform if not present
      include_role:
        name: install_terraform

    # ============================================
    # Phase 1.6: Create Terraform Configuration
    # ============================================
    - name: Create main.tf configuration file
      copy:
        content: |
          terraform {
            required_version = ">= 1.0"
            required_providers {
              aws = {
                source  = "hashicorp/aws"
                version = "~> 5.0"
              }
            }
          }

          provider "aws" {
            region = "{{ (tfc_variables.aws_region | default(aws_region) | default('us-east-1')) }}"
          }

          resource "aws_iam_role" "this" {
            name = "{{ (tfc_variables.role_name | default(role_name)) }}"
            {% set assume_policy = tfc_variables.assume_role_policy | default(assume_role_policy, '') %}
            {% if assume_policy | length > 0 %}
            {% set escaped_policy = assume_policy | replace('\n', '\\n') | replace('\r', '') | replace('"', '\\"') %}
            assume_role_policy = jsonencode(jsondecode("{{ escaped_policy }}"))
            {% else %}
            assume_role_policy = jsonencode({
              Version = "2012-10-17"
              Statement = [
                {
                  Effect = "Allow"
                  Principal = {
                    Service = "ec2.amazonaws.com"
                  }
                  Action = "sts:AssumeRole"
                }
              ]
            })
            {% endif %}
          }

          {% set policy_arns = tfc_variables.managed_policy_arns | default(managed_policy_arns, '') %}
          {% if policy_arns | length > 0 %}
          {% if policy_arns is string %}
          {% set policies = policy_arns.split(',') %}
          {% for policy in policies %}
          resource "aws_iam_role_policy_attachment" "managed_{{ loop.index }}" {
            role       = aws_iam_role.this.name
            policy_arn = "{{ policy.strip() }}"
          }
          {% endfor %}
          {% else %}
          {% for policy in policy_arns %}
          resource "aws_iam_role_policy_attachment" "managed_{{ loop.index }}" {
            role       = aws_iam_role.this.name
            policy_arn = "{{ policy }}"
          }
          {% endfor %}
          {% endif %}
          {% endif %}

          output "iam_role_arn" {
            value = aws_iam_role.this.arn
          }

          output "iam_role_name" {
            value = aws_iam_role.this.name
          }
        dest: "/tmp/workspaces/{{ tfc_workspace_name }}/main.tf"
        mode: '0644'
      when: tfc_pattern_repo_name is defined

    # ============================================
    # Phase 2: Terraform Plan
    # ============================================
    - name: Execute terraform plan
      include_role:
        name: terraform_plan
      vars:
        workspace_path: "/tmp/workspaces/{{ tfc_workspace_name }}"
        terraform_vars: "{{ tfc_variables | default({}) }}"
        aws_access_key_id: "{{ tfc_variables.aws_access_key_id | default(aws_access_key_id | default('')) }}"
        aws_secret_access_key: "{{ tfc_variables.aws_secret_access_key | default(aws_secret_access_key | default('')) }}"
        aws_session_token: "{{ tfc_variables.aws_session_token | default(aws_session_token | default('')) }}"
      register: plan_result
      
    - name: Set plan result facts from role
      set_fact:
        plan_status: "{{ plan_status | default('unknown') }}"
        plan_output: "{{ plan_output | default('') }}"
        plan_error: "{{ plan_error | default('') }}"

    # ============================================
    # Phase 3: Send Plan Success Callback
    # ============================================
    - name: Send plan success callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "plan"
        callback_status: "success"
        callback_endpoint: "plan_success"
        callback_plan_output: "{{ plan_output | default('') }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when: 
        - plan_status == 'success'
        - callback_url is defined and callback_url | length > 0
      ignore_errors: yes

    # ============================================
    # Phase 4: Send Plan Failed Callback
    # ============================================
    - name: Send plan failed callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "plan"
        callback_status: "failed"
        callback_endpoint: "plan_failed"
        callback_error: "{{ plan_error | default('Plan execution failed') }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when: 
        - plan_status == 'failed'
        - callback_url is defined and callback_url | length > 0
      ignore_errors: yes

    # ============================================
    # Phase 5: Terraform Apply (if plan succeeded)
    # ============================================
    - name: Execute terraform apply
      include_role:
        name: terraform_apply
      vars:
        workspace_path: "/tmp/workspaces/{{ tfc_workspace_name }}"
      register: apply_result
      when: plan_status == 'success'

    # ============================================
    # Phase 6: Send Apply Success Callback
    # ============================================
    - name: Send apply success callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "apply"
        callback_status: "success"
        callback_endpoint: "apply_success"
        callback_outputs: "{{ terraform_outputs | default({}) }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when:
        - plan_status == 'success'
        - apply_status == 'success'

    # ============================================
    # Phase 7: Send Apply Failed Callback
    # ============================================
    - name: Send apply failed callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "apply"
        callback_status: "failed"
        callback_endpoint: "apply_failed"
        callback_error: "{{ apply_error | default('Apply execution failed') }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when:
        - plan_status == 'success'
        - apply_status == 'failed'
        - callback_url is defined and callback_url | length > 0
      ignore_errors: yes

    # ============================================
    # Phase 8: Final Summary
    # ============================================
    - name: Display execution summary
      debug:
        msg:
          - "=== Terraform Execution Complete ==="
          - "Plan Status: {{ plan_status | default('unknown') }}"
          - "Apply Status: {{ apply_status | default('skipped') }}"
          - "Workspace: {{ tfc_workspace_name }}"
