---
# Terraform Cloud execution playbook with approval node
# Orchestrates TFC workspace, plan, approval, and apply phases with callbacks

- name: Terraform Cloud Provision Playbook (With Approval)
  hosts: localhost
  gather_facts: yes
  vars:
    operation: "{{ tfc_operation | default('create') }}"
    
  tasks:
    - name: Display execution context
      debug:
        msg:
          - "=== Terraform Cloud Execution Started (With Approval) ==="
          - "Operation: {{ operation }}"
          - "Organization: {{ tfc_organization }}"
          - "Workspace: {{ tfc_workspace_name }}"
          - "Use TFC: {{ use_tfc | default(false) }}"

    # ============================================
    # Phase 1: Create/Get TFC Workspace
    # ============================================
    - name: Create or get TFC workspace
      include_role:
        name: tfc_workspace
      vars:
        tfc_organization: "{{ tfc_organization }}"
        tfc_workspace_name: "{{ tfc_workspace_name }}"
        tfc_api_token: "{{ tfc_api_token }}"
        tfc_workspace_variables: "{{ tfc_variables | default({}) }}"
      register: workspace_result

    # ============================================
    # Phase 2: Create TFC Plan Run
    # ============================================
    - name: Create and monitor TFC plan run
      include_role:
        name: tfc_plan
      vars:
        tfc_workspace_id: "{{ workspace_result.tfc_workspace_id }}"
        tfc_api_token: "{{ tfc_api_token }}"
        tfc_run_message: "Plan run for {{ tfc_workspace_name }}"
        tfc_run_is_destroy: "{{ operation == 'destroy' }}"
      register: plan_result

    # ============================================
    # Phase 3: Send Plan Success Callback
    # ============================================
    - name: Send plan success callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "plan"
        callback_status: "success"
        callback_endpoint: "plan_success"
        callback_plan_output: "{{ plan_result.plan_output | default('') }}"
        terraform_run_id: "{{ plan_result.tfc_run_id }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when: plan_result.plan_status == 'success'

    # ============================================
    # Phase 4: Send Plan Failed Callback
    # ============================================
    - name: Send plan failed callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "plan"
        callback_status: "failed"
        callback_endpoint: "plan_failed"
        callback_error: "{{ plan_result.plan_error | default('Plan execution failed') }}"
        terraform_run_id: "{{ plan_result.tfc_run_id }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when: plan_result.plan_status == 'failed'
      ignore_errors: yes

    # ============================================
    # Phase 5: Send Waiting for Approval Callback
    # ============================================
    - name: Send waiting for approval callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "plan"
        callback_status: "waiting_approval"
        callback_endpoint: "plan_success"
        callback_plan_output: "{{ plan_result.plan_output | default('') }}"
        terraform_run_id: "{{ plan_result.tfc_run_id }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when: plan_result.plan_status == 'success'

    # ============================================
    # Phase 6: Approval Node (AAP Workflow handles this)
    # ============================================
    - name: Validate approval decision
      include_role:
        name: approval_wait
      when: plan_result.plan_status == 'success'

    # ============================================
    # Phase 7: Send Approval Granted Callback
    # ============================================
    - name: Send approval granted callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "approval"
        callback_status: "success"
        callback_endpoint: "approval_granted"
        terraform_run_id: "{{ plan_result.tfc_run_id }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when:
        - plan_result.plan_status == 'success'
        - ansible_awx_workflow_approval_status | default('') == 'approved'

    # ============================================
    # Phase 8: Send Approval Denied Callback
    # ============================================
    - name: Send approval denied callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "approval"
        callback_status: "failed"
        callback_endpoint: "approval_denied"
        callback_error: "Workflow approval was denied"
        terraform_run_id: "{{ plan_result.tfc_run_id }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when:
        - plan_result.plan_status == 'success'
        - ansible_awx_workflow_approval_status | default('') == 'denied'
      ignore_errors: yes

    # ============================================
    # Phase 9: Create TFC Apply Run (only if approved)
    # ============================================
    - name: Create and monitor TFC apply run
      include_role:
        name: tfc_apply
      vars:
        tfc_workspace_id: "{{ workspace_result.tfc_workspace_id }}"
        tfc_run_id: "{{ plan_result.tfc_run_id }}"
        tfc_api_token: "{{ tfc_api_token }}"
      register: apply_result
      when:
        - plan_result.plan_status == 'success'
        - ansible_awx_workflow_approval_status | default('') == 'approved'

    # ============================================
    # Phase 10: Send Apply Success Callback
    # ============================================
    - name: Send apply success callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "apply"
        callback_status: "success"
        callback_endpoint: "apply_success"
        callback_outputs: "{{ apply_result.terraform_outputs | default({}) }}"
        terraform_run_id: "{{ plan_result.tfc_run_id }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when:
        - plan_result.plan_status == 'success'
        - ansible_awx_workflow_approval_status | default('') == 'approved'
        - apply_result.apply_status == 'success'

    # ============================================
    # Phase 11: Send Apply Failed Callback
    # ============================================
    - name: Send apply failed callback
      include_role:
        name: callback_notify
      vars:
        callback_phase: "apply"
        callback_status: "failed"
        callback_endpoint: "apply_failed"
        callback_error: "{{ apply_result.apply_error | default('Apply execution failed') }}"
        terraform_run_id: "{{ plan_result.tfc_run_id }}"
        deployment_id: "{{ tfc_workspace_name }}"
        execution_id: "{{ ansible_date_time.epoch }}"
      when:
        - plan_result.plan_status == 'success'
        - ansible_awx_workflow_approval_status | default('') == 'approved'
        - apply_result.apply_status == 'failed'
      ignore_errors: yes

    # ============================================
    # Phase 12: Final Summary
    # ============================================
    - name: Display execution summary
      debug:
        msg:
          - "=== Terraform Cloud Execution Complete ==="
          - "Plan Status: {{ plan_result.plan_status | default('unknown') }}"
          - "Approval Status: {{ ansible_awx_workflow_approval_status | default('unknown') }}"
          - "Apply Status: {{ apply_result.apply_status | default('skipped') }}"
          - "Workspace: {{ tfc_workspace_name }}"
          - "Run ID: {{ plan_result.tfc_run_id | default('unknown') }}"
