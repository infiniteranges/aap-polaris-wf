---
# Terraform Clone Repository Playbook
# Clones the Terraform module repository to the workspace

- name: Clone Terraform Repository
  hosts: localhost
  gather_facts: yes
  
  tasks:
    # ============================================
    # Phase 0.1: Determine workspace name (support both TFC and local Terraform)
    # ============================================
    - name: Set workspace name (support both tfc_workspace_name and workspace_name)
      set_fact:
        workspace_name: "{{ tfc_workspace_name | default(workspace_name) | default('') }}"
    
    - name: Generate workspace name from variables if not set (deterministic hash)
      set_fact:
        workspace_name: "{{ 'terraform-' + (role_name | default(resource_name | default('resource')) | default('deployment')) + '-' + (aws_region | default(region | default('us-east-1'))) + '-' + ((role_name | default(resource_name | default('')) | default('') + aws_region | default(region | default('')) | default('') + tfc_pattern_repo_name | default('') | default('')) | hash('sha1') | truncate(8, True, '')) }}"
      when: workspace_name | length == 0

    - name: Display execution context
      debug:
        msg:
          - "=== Terraform Repository Clone Started ==="
          - "Repository: {{ tfc_pattern_repo_name | default('') }}"
          - "Version: {{ tfc_pattern_version | default('') }}"
          - "Workspace: {{ workspace_name }}"
          - "Cloud Provider: {{ tfc_cloud_provider | default('aws') }}"

    - name: Set workspace path (use project directory for shared access)
      set_fact:
        workspace_path: "{{ ansible_env.AWX_PROJECT_ROOT | default('/runner/project') }}/workspaces/{{ workspace_name }}"
    
    - name: Ensure workspace directory exists
      file:
        path: "{{ workspace_path }}"
        state: directory
        mode: '0755'
      when: workspace_name is defined and workspace_name | length > 0

    - name: Clone repository to module subdirectory
      include_role:
        name: clone_repo
      vars:
        repo_url: "{{ tfc_pattern_repo_name }}"
        repo_version: "{{ tfc_pattern_version }}"
        repo_dest: "{{ workspace_path }}/module"
      when: 
        - workspace_name is defined and workspace_name | length > 0
        - tfc_pattern_repo_name is defined

    # Share workspace_name and workspace_path with subsequent jobs in the workflow
    - name: Share workspace info with workflow
      set_stats:
        data:
          workspace_name: "{{ workspace_name }}"
          workspace_path: "{{ workspace_path }}"
        per_host: false
        aggregate: true
      when: workspace_name is defined and workspace_name | length > 0
